<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="receiver_fiscal_info">
        <strong>
            <t t-if="o.move_type in ('in_invoice', 'in_refund')">Proveedor:</t>
            <t t-else="">Cliente:</t>
        </strong> 
        <span t-field="o.commercial_partner_id.name"/>
        <div t-if="o.partner_id.vat">
            <strong>
                <t t-if="o.company_id.account_fiscal_country_id.vat_label" t-esc="o.company_id.account_fiscal_country_id.vat_label" id="inv_tax_id_label"/>
                <t t-else="">Tax ID</t>: </strong><span t-field="o.partner_id.vat"/>
        </div>
        <!-- <address class="mb-0" t-field="o.commercial_partner_id" t-options='{"widget": "contact", "fields": ["address"], "no_marker": True}'/> -->
    </template>

    <template id="report_invoice_document_inherit" inherit_id="account.report_invoice_document">
    
         

        <xpath expr="//div[hasclass('row')][1]" position="attributes">
            <attribute name="t-if">not (o.is_l10n_do_fiscal_invoice and o.is_invoice() and o.fiscal_type_id and o.fiscal_type_id.assigned_sequence)</attribute>
        </xpath>

        <xpath expr="//div[@name='invoice_date']" position="attributes">
            <attribute name="t-if">not l10n_do_fiscal_invoice</attribute>
        </xpath>

        <xpath expr="//div[@name='reference']" position="attributes">
            <attribute name="t-if">not l10n_do_fiscal_invoice</attribute>
        </xpath>

        <xpath expr="//div[hasclass('row')][1]" position="after">
            <t t-set="l10n_do_fiscal_invoice" t-value="o.is_l10n_do_fiscal_invoice and o.is_invoice() and o.fiscal_type_id and o.fiscal_type_id.assigned_sequence"/>
            <t t-if="l10n_do_fiscal_invoice">
                <div class="col-6" t-if="o.company_id.external_report_layout_id and o.company_id.external_report_layout_id.xml_id != 'web.external_layout_standard'">
                    <br/>
                    <div t-if="not forced_vat" style="margin-top: 0; margin-bottom: 0;">
                        <t t-if="o.company_id.vat">
                            <strong>
                            <t t-if="o.company_id.account_fiscal_country_id.vat_label" t-esc="o.company_id.account_fiscal_country_id.vat_label" id="company_inv_tax_id_label"/>
                            <t t-else="">Tax ID</t>: </strong><span t-field="o.company_id.vat"/>
                        </t>
                    </div>
                    <div t-if="o.company_id.phone" style="margin-top: 0; margin-bottom: 0;">
                        <strong>Teléfono:</strong> <span t-field="o.company_id.phone"/>
                    </div>
                    <div t-if="o.invoice_date">
                        <strong>Date:</strong> <span t-field="o.invoice_date"/>
                    </div>
                </div>
                <div class="row pt-2">
                    <t t-if="o.partner_shipping_id and (o.partner_shipping_id != o.partner_id)">
                        <div class="col-6" name="fiscal_address_not_same_as_shipping">
                            <t t-call="l10n_do_accounting.receiver_fiscal_info"/>
                        </div>
                        <div class="col-6">
                            <div groups="account.group_delivery_invoice_address">
                                <strong>Shipping Address:</strong>
                                <!-- <div t-field="o.partner_shipping_id" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/> -->
                            </div>
                        </div>
                    </t>
                    <t t-elif="o.partner_shipping_id and (o.partner_shipping_id == o.partner_id)">
                        <div class="col-6" name="fiscal_address_same_as_shipping">
                            <t t-call="l10n_do_accounting.receiver_fiscal_info"/>
                        </div>
                    </t>
                    <t t-else="">
                        <div class="col-6" name="fiscal_info_minimal">
                            <t t-call="l10n_do_accounting.fiscal_info_minimal" />
                        </div>
                        <div class="col-6" name="fiscal_no_shipping">
                            <t t-call="l10n_do_accounting.receiver_fiscal_info"/>
                        </div>
                    </t>
                </div>
                <div style="border-bottom: 1px solid black;"></div>
            </t>
        </xpath>
        <xpath expr="//div[@class='mt-5']/div[@class='page']/h2" position="replace">
            <h2>
                <!-- <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">Factura</span> -->
                <span t-if="o.move_type == 'out_invoice' and o.state == 'draft'">Borrador Factura</span>
                <span t-if="o.move_type == 'out_invoice' and o.state == 'cancel'">Factura Cancelada</span>
                <span t-if="o.move_type == 'out_refund'">Nota de Crédito</span>
                <span t-if="o.move_type == 'in_refund'">Nota de Crédito Proveedor</span>
                <span t-if="o.move_type == 'in_invoice'">Factura Proveedor</span>
                <span t-if="False and o.name != '/'" t-field="o.name"/>
            </h2>
        </xpath>
        <xpath expr="//div[@name='invoice_date']" position="replace">
            <div class="col-auto col-3 mw-100 mb-2" t-if="False" name="invoice_date">
                <t t-if="o.move_type == 'out_invoice'"><strong>Fecha Factura:</strong></t>
                <t t-elif="o.move_type == 'out_refund'"><strong>Fecha de Nota de Crédito:</strong></t>
                <t t-elif="o.move_type == 'out_receipt'"><strong>Fecha Recepción:</strong></t>
                <t t-else=""><strong>Fecha:</strong></t>
                <p class="m-0" t-field="o.invoice_date"/>
            </div>
        </xpath>
        <xpath expr="//div[@name='due_date']" position="replace">
            <div class="col-auto col-3 mw-100 mb-2" t-if="False" name="due_date">
                <strong>Fecha de Vencimiento:</strong>
                <p class="m-0" t-field="o.invoice_date_due"/>
            </div>
        </xpath>

        <xpath expr="//table[@name='invoice_line_table']" position="before">
        </xpath>

        <xpath expr="//table[@name='invoice_line_table']/thead" position="replace">
            <thead>
                <tr>
                    <th name="th_description" class="text-start"><span>Descripción</span></th>
                    <th name="th_quantity" class="text-end"><span>Cantidad</span></th>
                    <th name="th_priceunit" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"><span>Precio Unitario</span></th>
                    <!-- <th name="th_taxes" t-attf-class="text-start {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"><span>Impuestos</span></th> -->
                    <th name="th_subtotal" class="text-end">
                        <span groups="account.group_show_line_subtotals_tax_excluded">Subtotal</span>
                        <span groups="account.group_show_line_subtotals_tax_included">Total</span>
                    </th>
                </tr>
            </thead>
        </xpath>
        <xpath expr="//tbody[@class='invoice_tbody']" position="replace">
            <tbody class="invoice_tbody">
                <t t-set="current_subtotal" t-value="0"/>
                    <t t-set="lines" t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>

                    <t t-foreach="lines" t-as="line">
                        <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                        <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>

                        <tr t-att-class="'bg-200 fw-bold o_line_section' if line.display_type == 'line_section' else 'fst-italic o_line_note' if line.display_type == 'line_note' else ''">
                            <t t-if="line.display_type == 'product'" name="account_invoice_line_accountable">
                                <td name="account_invoice_line_name">
                                    <t t-if="line.product_id">
                                        <span t-field="line.product_id.name" t-options="{'widget': 'text'}"/>
                                    </t>
                                    <t t-else="">
                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                    </t>
                                </td>
                                <td class="text-end">
                                    <span t-field="line.quantity"/>
                                    <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                                </td>
                                <td t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                    <!-- <span class="text-nowrap" t-field="line.price_unit"/>
                                </td>
                                <t t-set="taxes" t-value="', '.join([(tax.description or tax.name) for tax in line.tax_ids])"/>
                                <td name="td_taxes" t-attf-class="text-start {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }} {{ 'text-nowrap' if len(taxes) &lt; 10 else '' }}">
                                    <span t-out="taxes" id="line_tax_ids">Tax 15%</span> -->
                                    <span class="text-nowrap" t-field="line.price_unit" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </td>
                                <td class="text-end o_price_total">
                                    <span class="text-nowrap" t-field="line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                                    <span class="text-nowrap" t-field="line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                                </td>
                            </t>
                            <t t-if="line.display_type == 'line_section'">
                                <td colspan="99">
                                    <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                </td>
                                <t t-set="current_section" t-value="line"/>
                                <t t-set="current_subtotal" t-value="0"/>
                            </t>
                            <t t-if="line.display_type == 'line_note'">
                                <td colspan="99">
                                    <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                </td>
                            </t>
                        </tr>

                        <t t-if="current_section and (line_last or lines[line_index+1].display_type == 'line_section')">
                            <tr class="is-subtotal text-end">
                                <td colspan="99">
                                    <strong class="mr16">Subtotal</strong>
                                    <span t-esc="current_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                </td>
                        </tr>
                    </t>
                </t>
            </tbody>
        </xpath>

        <xpath expr="//div[@class='clearfix mb-4']" position="attributes">
            <attribute name="class">clearfix mb-0</attribute>
        </xpath>
        <xpath expr="//div[@class='clearfix mb-0']" position="after">
            <t t-if="o.move_type in ('out_invoice', 'out_refund')">
                <!-- FIRMAS -->
                <div class="row" style="page-break-inside: avoid; margin-top: 5px;">
                    <div class="col-4" style="padding-top: 120px; margin-left: 10px;">
                        <div class="border-bottom border-2 border-dark"></div>
                        <p class="text-center mb-0 mt-2 align-bottom">Firma Vendedor</p>
                    </div>
                    <div class="col-4 text-center" style="padding-top: 120px;">
                        <div class="border-bottom border-2 border-dark" style="max-width: 200px; margin-left: auto; margin-right: auto;"></div>
                        <p class="text-center mb-0 mt-2 align-bottom">Firma Despacho</p>
                    </div>
                    <div class="col-4" style="padding-top: 120px; padding-right: 10px; position: relative;">
                        <div class="border-bottom border-2 border-dark"></div>
                        <p class="text-center mb-0 mt-2 align-bottom">Firma Cliente</p>
                        <div t-if="o.company_stamp" style="position: absolute; bottom: -180px; right: 0;">
                            <img t-att-src="image_data_uri(o.company_stamp)" style="max-height:200px; max-width:200px;" alt="Sello"/>
                        </div>
                    </div>
                </div>

            </t>
        </xpath>
        <xpath expr="//p[@name='payment_communication']" position="replace">
        </xpath>

        <xpath expr="//td[@name='account_invoice_line_name']" position="replace">
            <td name="account_invoice_line_name">
                <t t-if="line.product_id">
                    <span t-field="line.product_id.name" t-options="{'widget': 'text'}"/>
                </t>
                <t t-else="">
                    <span t-field="line.name" t-options="{'widget': 'text'}"/>
                </t>
            </td>
        </xpath>
        <xpath expr="//div[@class='page']" position="before">
            <style>
                #total table tr:last-child td {
                    font-weight: bold !important;
                    font-size: 1.1em;
                }
                #total {
                    margin-bottom: 0.1rem !important;
                }
                div.clearfix.mb-0 {
                    margin-bottom: 0 !important;
                }
                #total table {
                    margin-bottom: 0 !important;
                }
            </style>
        </xpath>
    </template>

    <template id="document_tax_totals_inherit" inherit_id="account.document_tax_totals">
        <!-- Reemplazar "Untaxed Amount" por "Base Imponible" -->
        <xpath expr="//tr[contains(@class, 'o_subtotal')]/td[not(contains(@class, 'text-end'))][1]" position="replace">
            <td>Base Imponible</td>
        </xpath>
        
        <xpath expr="//tr[@class='border-black o_subtotal'][1]" position="after">
            <t t-if="display_discount and o and o._name == 'account.move'">
                <t t-set="total_discount" t-value="sum(line.quantity * line.price_unit * line.discount / 100.0 for line in o.invoice_line_ids if line.display_type == 'product' and line.discount)"/>
                <tr t-if="total_discount > 0" class="">
                    <td>Descuento</td>
                    <td class="text-end">
                        <span t-esc="'- %s' % o.currency_id.format(total_discount)"/>
                    </td>
                </tr>
            </t>
        </xpath>
    </template>
</odoo>
