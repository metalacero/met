<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">

    <t t-name="OrderReceipt" t-inherit="point_of_sale.OrderReceipt" t-inherit-mode="extension" owl="1">

        <!-- Ocultar el detalle de impuestos (18% ITBIS Ventas) en recibos fiscales -->
        <xpath expr="//t[@t-if='isTaxIncluded']" position="replace">
            <t t-if="isTaxIncluded">
                <t t-if="!receipt.l10n_do_fiscal_journal" id="tax-details" t-foreach="receipt.tax_details" t-as="tax" t-key="tax.tax.id">
                    <div>
                        <t t-esc="tax.name" />
                        <span t-esc='env.pos.format_currency_no_symbol(tax.amount)' class="pos-receipt-right-align"/>
                    </div>
                </t>
                <div>
                    Total Taxes
                    <span t-esc="env.pos.format_currency(receipt.total_tax)" class="pos-receipt-right-align"/>
                </div>
            </t>
        </xpath>


        <!-- Sobrescribir el contenido del div pos-receipt-contact para cambiar NIF/NIC por RNC -->
        <xpath expr="//div[hasclass('pos-receipt-contact')]" position="replace">
            <div class="pos-receipt-contact">
                <t t-if="env.pos.company">
                    <t t-if="env.pos.company.name">
                        <t t-esc="env.pos.company.name"/>
                    </t>
                    <t t-if="env.pos.company.street">
                        <br/><t t-esc="env.pos.company.street"/>
                    </t>
                    <t t-if="env.pos.company.street2">
                        <t t-esc="', ' + env.pos.company.street2"/>
                    </t>
                    <t t-if="env.pos.company.city">
                        <br/><t t-esc="env.pos.company.city"/>
                    </t>
                    <t t-if="env.pos.company.state_id">
                        <t t-esc="', ' + env.pos.company.state_id[1]"/>
                    </t>
                    <t t-if="env.pos.company.zip">
                        <t t-esc="' ' + env.pos.company.zip"/>
                    </t>
                    <t t-if="env.pos.company.country_id">
                        <br/><t t-esc="env.pos.company.country_id[1]"/>
                    </t>
                    <t t-if="env.pos.company.vat">
                        <br/>RNC: <t t-esc="env.pos.company.vat"/>
                    </t>
                    <t t-if="env.pos.company.phone">
                        <br/><t t-esc="env.pos.company.phone"/>
                    </t>
                </t>
            </div>
        </xpath>

        <xpath expr="//div[hasclass('pos-receipt-contact')]" position="after">
            <t t-if="receipt.l10n_do_fiscal_journal">
                <div class="pos-receipt-font-75" t-if="receipt.partner">
                    <br/>
                    <div>
                        Customer: <t t-esc="receipt.partner.name"/>
                    </div>
                    <div t-if="receipt.partner.vat">
                        RNC / Cedula: <t t-esc="receipt.partner.vat"/>
                    </div>
                    <div t-if="receipt.partner.street">
                        <t t-esc="receipt.partner.street"/><t t-if="receipt.partner.street2" t-esc="', ' + receipt.partner.street2"/>
                    </div>
                    <div t-if="receipt.partner.city">
                        <t t-esc="receipt.partner.city"/>
                    </div>
                    <div t-if="receipt.partner.state_id">
                        <t t-esc="receipt.partner.state_id[1]"/>
                    </div>
                    <div t-if="receipt.partner.zip">
                        <t t-esc="receipt.partner.zip"/>
                    </div>
                    <div t-if="receipt.partner.country_id and receipt.partner.street">
                        <t t-esc="receipt.partner.country_id[1]"/>
                    </div>
                </div>
                <div t-if="receipt.ncf">
                    <br/>
                    <div class="pos-receipt-contact">
                        Authorized by DGII
                    </div>
                    <br/>
                    <div class="pos-receipt-font-75">
                        <div>
                            <t t-if="receipt.date.localestring">
                                <div>
                                    <t t-esc="receipt.date.localestring" />
                                </div>
                            </t>
                            <t t-else="">
                                <div>
                                    <t t-esc="receipt.date.validation_date" />
                                </div>
                            </t>
                        </div>
                        <div>
                            NCF: <t t-esc="receipt.ncf"/>
                        </div>
                        <div t-if="receipt.ncf_expiration_date">
                            Expiration date NCF: <t t-esc="receipt.ncf_expiration_date"/>
                        </div>
                        <div t-if="receipt.ncf_origin_out">
                            Affect: <t t-esc="receipt.ncf_origin_out"/>
                        </div>
                    </div>
                </div>
            </t>
        </xpath>

        <xpath expr="//div[hasclass('orderlines')]" position="before">
            <style>
                /* Ocultar cualquier div que aparezca después de do-pos-receipt-lines */
                .orderlines > div > div.do-pos-receipt-lines + div:not(.do-pos-receipt-lines):not(.pos-receipt-fiscal-type-name):not(.do-pos-receipt-titles):not(.price_display) {
                    display: none !important;
                }
                /* Ocultar cualquier elemento hermano después de do-pos-receipt-lines */
                .orderlines > div > div.do-pos-receipt-lines ~ div:not(.do-pos-receipt-lines):not(.pos-receipt-fiscal-type-name):not(.do-pos-receipt-titles):not(.price_display) {
                    display: none !important;
                }
                /* Ocultar elementos dentro de orderlines que no sean parte de la estructura principal */
                .orderlines > div > div:not(.do-pos-receipt-lines):not(.pos-receipt-fiscal-type-name):not(.do-pos-receipt-titles):not(.price_display):not(span) {
                    display: none !important;
                }
                /* Línea de nombre del producto con badge de cantidad a la derecha */
                .do-pos-receipt-name-line {
                    display: flex;
                    justify-content: space-between;
                    align-items: baseline;
                    width: 100%;
                }
                .do-pos-receipt-name-line > span:first-child {
                    flex: 1 1 auto;
                    min-width: 0;
                }
                .do-pos-receipt-qty-badge {
                    font-weight: bold;
                    white-space: nowrap;
                    flex-shrink: 0;
                    margin-left: 12px;
                }
            </style>
            <t t-if="receipt.l10n_do_fiscal_journal">
                <div class="pos-receipt-fiscal-type-name" t-if="receipt.ncf">
                    <t t-esc="receipt.fiscal_type.name"/>
                </div>
                <div class="do-pos-receipt-titles">
                    <div>DESCRIPTION</div>
                    <div class="right">ITBIS</div>
                    <div class="right">VALUE</div>
                </div>
            </t>
        </xpath>

        <xpath expr="//div[@class='pos-receipt-right-align' and text()='--------']" position="replace">
            <div t-if="!receipt.l10n_do_fiscal_journal" class="pos-receipt-right-align">--------</div>
            <div t-if="receipt.l10n_do_fiscal_journal" class="pos-receipt-fiscal-type-name"></div>
        </xpath>

    </t>

    <t t-name="OrderLinesReceipt" t-inherit="point_of_sale.OrderLinesReceipt" t-inherit-mode="extension" owl="1">
        <xpath expr="//div[hasclass('pos-receipt-qty-per-price')]" position="attributes">
            <attribute name="t-if">!receipt.l10n_do_fiscal_journal</attribute>
        </xpath>

        <!-- Reemplazar el div del nombre para mostrar badge "xN" a la derecha -->
        <xpath expr="//div[@t-esc='line.product_name_wrapped[0]']" position="replace">
            <div class="do-pos-receipt-name-line">
                <span t-esc="line.product_name_wrapped[0]"/>
                <span class="do-pos-receipt-qty-badge" t-if="line.qty_badge">
                    <t t-esc="line.qty_badge"/>
                </span>
            </div>
        </xpath>

        <xpath expr="//div[hasclass('pos-receipt-qty-per-price')]" position="after">
            <div class="do-pos-receipt-lines" t-if="receipt.l10n_do_fiscal_journal">
                <div>
                    <t t-esc="Math.round(line.quantity * Math.pow(10, env.pos.dp['Product Unit of Measure'])) / Math.pow(10, env.pos.dp['Product Unit of Measure'])"/>
                    <t t-if="!line.is_in_unit" t-esc="line.unit_name" />
                    x
                    <t t-esc="env.pos.format_currency(line.price_display_one)" />
                </div>
                <div class="price_display right">
                    <t t-esc="env.pos.format_currency_no_symbol(line.l10n_do_itbis)" />
                </div>
                <span class="price_display right">
                    <t t-esc="env.pos.format_currency_no_symbol(line.price_display)" />
                </span>
            </div>
        </xpath>

    </t>

    <!--TODO: this part is for use posbox-->
    <!--<t t-extend="XmlReceipt">-->

    <!--</t>-->

</templates>
